## useful commands
# list-keys -T prefix

set -g mouse on
set -g base-index 1

set -g status-interval 3 # Update status every 3 seconds
set -g detach-on-destroy off # Don't detach session when last window is closed

# Notifying if other windows has activities
setw -g monitor-activity on

# top status bar
set -g status-position top

# set -g default-terminal "tmux-256color"
# enable clipboard through osc 52 when over ssh or on macOS
# if-shell '[ -n "$SSH_CLIENT" ] || [ "$(uname)" = "Darwin" ]' { set -g -s set-clipboard on }
set -g set-clipboard on

# update environment variables on reattach
# set -ag update-environment "SSH_CONNECTION SSH_TTY SSH_AUTH_SOCK"
set -g update-environment "SSH_CONNECTION SSH_TTY SSH_AUTH_SOCK"

set-hook -g client-attached "run-shell update-zsh-env-inside-tmux"
# set-environment -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock
# set-hook -g client-attached 'run "eval export $(tmux show-env | grep SSH_AUTH_SOCK)"'
# set-hook -g client-attached 'run "$HOME/.config/tmux/attach.sh"'

# Undercurl
set -g default-terminal "${TERM}"
set -ag terminal-overrides ",xterm-256color:RGB" # macos ?
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# vim keys
setw -g mode-keys vi

set -s copy-command 'wl-copy'
bind-key -T copy-mode-vi 'Escape' send -X cancel
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
# bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'wl-copy'

# Renumber windows on window close
set -g renumber-windows on

# do not rename windows automatically
set-option -g automatic-rename on
# set-option -g automatic-rename-format '#{b:pane_current_command}:#{b:pane_current_path}'
# set-option -g automatic-rename-format '#{b:pane_current_command} #[fg=#{@thm_overlay_0}]#{b:pane_current_path}'

# set -g set-titles on
# set -g set-titles-string '#W'

### plugins
set -g @plugin 'tmux-plugins/tpm' # tmux plugin manager
## tmux-sensible: sensible tmux defaults
set -g @plugin 'tmux-plugins/tmux-sensible' # sensible defaults
## tmux-resurrect: tmux sessions
set -g @plugin 'tmux-plugins/tmux-resurrect' # tmux sessions
## tmux-continuum: persisting sessions
set -g @plugin 'tmux-plugins/tmux-continuum' # auto save tmux sessions
# systemd service
set -g @continuum-boot 'off' # 'on' | 'off'
set -g @continuum-systemd-start-cmd 'stop-server'
# set -g @continuum-restore 'on' # 'on' | 'off'
set -g @continuum-save-interval '5'
## vim-tmux-navigator: navigate seemlessly between vim and tmux
set -g @plugin 'christoomey/vim-tmux-navigator' # nvim/tmux integration
## catppuccin: theme
set -g @plugin 'catppuccin/tmux'

set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_host}"
set -g status-left ""

### plugin options
## tmux-resurrect
set -g @resurrect-capture-pane-contents 'on'

### status bar - monochrome theme
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "basic"
set -g @catppuccin_status_background "none"

# override mocha colors with monochrome palette (must be before tpm runs)
set -gq @thm_bg "#000000"
set -gq @thm_fg "#ffffff"
set -gq @thm_rosewater "#ffcb8b"
set -gq @thm_flamingo "#ffa198"
set -gq @thm_pink "#d2a8ff"
set -gq @thm_mauve "#d2a8ff"
set -gq @thm_red "#ff7b72"
set -gq @thm_maroon "#f47067"
set -gq @thm_peach "#ffa657"
set -gq @thm_yellow "#ffd580"
set -gq @thm_green "#7ee787"
set -gq @thm_teal "#7ee8d4"
set -gq @thm_sky "#7dcfff"
set -gq @thm_sapphire "#56b3ff"
set -gq @thm_blue "#79c0ff"
set -gq @thm_lavender "#ffffff"
set -gq @thm_subtext_1 "#ededed"
set -gq @thm_subtext_0 "#a1a1a1"
set -gq @thm_overlay_2 "#888888"
set -gq @thm_overlay_1 "#666666"
set -gq @thm_overlay_0 "#444444"
set -gq @thm_surface_2 "#333333"
set -gq @thm_surface_1 "#222222"
set -gq @thm_surface_0 "#171717"
set -gq @thm_mantle "#0a0a0a"
set -gq @thm_crust "#050505"

# monochrome window tabs
set -g @catppuccin_window_current_left_separator " "
set -g @catppuccin_window_current_middle_separator " "
set -g @catppuccin_window_current_right_separator " "
set -gq @catppuccin_window_number_color "#{@thm_overlay_1}"
set -gq @catppuccin_window_text_color "#{@thm_surface_0}"
set -gq @catppuccin_window_current_number_color "#{@thm_lavender}"
set -gq @catppuccin_window_current_text_color "#{@thm_surface_1}"
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W #{b:pane_current_path}"

# monochrome module colors (unset cached values so catppuccin re-derives them)
set -gu @catppuccin_status_application_icon_bg
set -gu @catppuccin_status_session_icon_bg
set -gu @catppuccin_status_host_icon_bg
set -gq @catppuccin_application_color "#{@thm_overlay_1}"
set -gq @catppuccin_session_color "#{?client_prefix,#{@thm_red},#{@thm_lavender}}"
set -gq @catppuccin_host_color "#{@thm_overlay_2}"

### keybindings
unbind C-b
set -g prefix C-a

unbind R
bind R source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# use vim keybindings for window splitting and navigation
unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind \"
bind - split-window -v -c "#{pane_current_path}"

### nvim tmux
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind & confirm-before -p "kill-window #W? (y/n)" kill-window
bind \$ command-prompt -I "#W" { rename-session "%%" }
bind , command-prompt -I "#W" { rename-window "%%" }
bind n next-window
bind p previous-window

# create new windows in the same directory
bind c new-window -c "#{pane_current_path}"

set -g @resurrect-save 'S'
set -g @resurrect-restore 'r'

run "~/.config/tmux/plugins/tpm/tpm"
