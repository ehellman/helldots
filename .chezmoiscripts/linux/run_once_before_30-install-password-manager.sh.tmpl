#!/bin/bash
{{- if eq .chezmoi.os "linux" }}
{{- if eq .features.passwordManager "true" }}
set -euo pipefail

# Include shared helpers
{{ template "bash/helpers.sh.tmpl" . }}

# Set up error handling
setup_error_handler

log "Checking password manager installation requirements"

{{- $pacman := list -}}
{{- $aur := list -}}

{{- if eq .host.headless "false" -}}
{{- $aur = append $aur "1password" -}}
{{- $pacman = append $pacman "gnome-keyring" -}}
{{- end -}}
{{- $aur = append $aur "1password-cli" -}}

# TODO: Copy the ssh config to 1password

{{ if $pacman -}}
log "Installing password manager dependencies via pacman"
if ! sudo pacman -S --needed {{ $pacman | join " " }}; then
  log "ERROR: Failed to install pacman packages for password manager"
  exit 1
fi
log "Successfully installed pacman packages"
{{- end }}

{{ if $aur -}}
log "Installing 1Password components via AUR"
if ! paru -S --needed {{ $aur | join " " }}; then
  log "ERROR: Failed to install AUR packages for password manager"
  exit 1
fi
log "Successfully installed 1Password components"
{{ end -}}

log "Password manager installation completed"
reset_sudo

{{- end }}
{{- end -}}

