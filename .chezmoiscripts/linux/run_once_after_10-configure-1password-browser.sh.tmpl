#!/bin/bash
set -euo pipefail

# Include shared helpers
{{ template "bash/helpers.sh.tmpl" . }}

# Set up error handling
setup_error_handler

log "Configuring 1Password browser integration for Zen browser"

folder_path="/etc/1password"
file_name="custom_allowed_browsers"
full_path="$folder_path/$file_name"

# Create directory if needed
if [ ! -d "$folder_path" ]; then
    log "Creating $folder_path"
    sudo mkdir "$folder_path"
    ensure_permissions "$folder_path" 0755
    ensure_owner "$folder_path" "root"
else
    log "$folder_path already exists, verifying permissions and ownership"
    ensure_owner "$folder_path" "root"
    ensure_permissions "$folder_path" 0755
fi

# Create file if needed
if [ ! -f "$full_path" ]; then
    log "Creating $full_path"
    sudo touch "$full_path"
    ensure_permissions "$full_path" 0644
    ensure_owner "$full_path" "root"
else
    log "$full_path already exists, verifying permissions and ownership"
    ensure_owner "$full_path" "root"
    ensure_permissions "$full_path" 0644
fi

# Add zen-bin to allowed browsers
if ! grep -Fxq "zen-bin" "$full_path"; then
    log "Adding zen-bin to $full_path"
    echo "zen-bin" | sudo tee -a "$full_path" > /dev/null
else
    log "zen-bin already exists in $full_path"
fi

log "1Password browser integration configured successfully"
reset_sudo